<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>排水法體積計算練習</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f9ff;
        }
        .canvas-container {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .water {
            transition: height 1s ease-in-out, y 1s ease-in-out;
        }
        .ball {
            filter: drop-shadow(1px 1px 1px rgba(0,0,0,0.3));
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4">

    <!-- Header -->
    <header class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-slate-800 mb-2">排水法體積計算練習</h1>
        <p class="text-slate-600">觀察排水桶與量筒的水位變化，計算鐵珠的體積。</p>
    </header>

    <!-- Main Game Area -->
    <main class="w-full max-w-5xl bg-white p-6 md:p-8 rounded-2xl shadow-xl">
        
        <!-- Visualization Panel -->
        <div class="flex flex-col md:flex-row justify-between items-end gap-4 mb-8 border-b pb-8">
            <!-- Stage 1: Initial Empty -->
            <div class="flex-1 flex flex-col items-center">
                <div class="text-slate-500 font-bold mb-2">初始狀態</div>
                <svg width="200" height="220" viewBox="0 0 200 220" class="w-full max-w-[200px]">
                    <!-- Bucket -->
                    <path d="M40 40 L40 180 Q40 200 60 200 L140 200 Q160 200 160 180 L160 80 L180 100" fill="none" stroke="#334155" stroke-width="3" stroke-linecap="round"/>
                    <line x1="160" y1="80" x2="160" y2="40" stroke="#334155" stroke-width="3"/>
                    <!-- Water in bucket (Full) -->
                    <path d="M43 80 L43 180 Q43 197 60 197 L140 197 Q157 197 157 180 L157 80 Z" fill="#bae6fd" opacity="0.6"/>
                    <line x1="43" y1="80" x2="157" y2="80" stroke="#0ea5e9" stroke-width="2"/>
                    
                    <!-- Measuring Cup (Empty) -->
                    <g transform="translate(180, 100) scale(0.6)">
                        <path d="M10 0 L10 180 Q10 200 30 200 L90 200 Q110 200 110 180 L110 0" fill="none" stroke="#334155" stroke-width="4"/>
                        <!-- Graduation marks -->
                        <line x1="10" y1="160" x2="30" y2="160" stroke="#334155" stroke-width="2"/>
                        <line x1="10" y1="120" x2="30" y2="120" stroke="#334155" stroke-width="2"/>
                        <line x1="10" y1="80" x2="30" y2="80" stroke="#334155" stroke-width="2"/>
                        <line x1="10" y1="40" x2="30" y2="40" stroke="#334155" stroke-width="2"/>
                    </g>
                </svg>
            </div>

            <!-- Arrow -->
            <div class="hidden md:block pb-20 text-orange-500 text-3xl"><i class="fas fa-arrow-right"></i></div>

            <!-- Stage 2: First Drop -->
            <div class="flex-1 flex flex-col items-center">
                <div class="text-blue-600 font-bold mb-2">步驟一</div>
                <svg id="stage2-svg" width="200" height="220" viewBox="0 0 200 220" class="w-full max-w-[200px]">
                    <!-- Content generated by JS -->
                </svg>
                <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-bold mt-2">
                    溢出水量: <span id="vol1-display">0</span> mL
                </div>
            </div>

            <!-- Arrow -->
            <div class="hidden md:block pb-20 text-orange-500 text-3xl"><i class="fas fa-arrow-right"></i></div>

            <!-- Stage 3: Second Drop -->
            <div class="flex-1 flex flex-col items-center">
                <div class="text-blue-600 font-bold mb-2">步驟二</div>
                <svg id="stage3-svg" width="200" height="220" viewBox="0 0 200 220" class="w-full max-w-[200px]">
                     <!-- Content generated by JS -->
                </svg>
                <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-bold mt-2">
                    總溢出水量: <span id="vol2-display">0</span> mL
                </div>
            </div>
        </div>

        <!-- Question Section -->
        <div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
            <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                <i class="fas fa-question-circle text-orange-500"></i> 題目
            </h2>
            <p id="question-text" class="text-lg text-slate-700 leading-relaxed mb-6">
                <!-- Generated Text -->
            </p>
            
            <div class="flex flex-col sm:flex-row items-center gap-4">
                <label class="text-lg font-bold text-slate-700">答案：</label>
                <div class="relative">
                    <input type="number" id="user-answer" class="w-32 px-4 py-2 text-xl border-2 border-slate-300 rounded-lg focus:border-blue-500 focus:outline-none text-center" placeholder="?">
                    <span class="absolute right-[-3.5rem] top-2 text-lg text-slate-600">cm³</span>
                </div>
                <button onclick="checkAnswer()" class="mt-4 sm:mt-0 px-8 py-2 bg-blue-600 hover:bg-blue-700 text-white text-lg font-bold rounded-lg shadow-md transition-colors">
                    提交答案
                </button>
                <button onclick="generateQuestion()" class="mt-4 sm:mt-0 px-6 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 text-lg font-bold rounded-lg transition-colors ml-auto">
                    <i class="fas fa-redo mr-2"></i>下一題
                </button>
            </div>
        </div>

        <!-- Feedback & Solution Section -->
        <div id="feedback-panel" class="hidden mt-6 p-6 rounded-xl border transition-all duration-500">
            <div id="feedback-title" class="text-2xl font-bold mb-4"></div>
            <div id="solution-content" class="text-slate-700 space-y-2"></div>
        </div>

    </main>

    <footer class="mt-12 text-slate-400 text-sm text-center">
        <p>© 2025 數學練習生成器</p>
    </footer>

    <script>
        // Game State
        let currentState = {
            largeVol: 0,
            smallVol: 0,
            initLarge: 0,
            initSmall: 0,
            addLarge: 0, // Number of large balls added in step 2
            addSmall: 0, // Number of small balls added in step 2
            vol1: 0,
            vol2: 0,
            targetType: 'small' // 'large' or 'small'
        };

        // Configuration for drawing
        const DRAW_CONFIG = {
            canX: 40, canY: 40, canWidth: 120, canHeight: 160,
            waterY: 80, // Level of spout
            ballBaseY: 190,
            largeRadius: 14,
            smallRadius: 9,
            cupX: 180, cupY: 100, cupScale: 0.6,
            maxVolDisplay: 300 // Max volume for measuring cup visual scaling
        };

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function generateQuestion() {
            // 1. Reset UI
            document.getElementById('feedback-panel').classList.add('hidden');
            document.getElementById('user-answer').value = '';
            document.getElementById('user-answer').classList.remove('border-green-500', 'border-red-500', 'bg-green-50', 'bg-red-50');

            // 2. Generate Logic
            // Volume of balls
            const largeVol = getRandomInt(30, 60); 
            const smallVol = getRandomInt(10, 25);
            
            // Step 1: Initial balls
            const initLarge = getRandomInt(1, 2);
            const initSmall = getRandomInt(1, 3);
            
            // Step 2: Added balls (Either add only Large or only Small to keep logic simple like the image)
            // Flip a coin to decide if we add Large or Small balls in step 2
            const addingLarge = Math.random() > 0.5;
            
            const addLarge = addingLarge ? getRandomInt(1, 3) : 0;
            const addSmall = addingLarge ? 0 : getRandomInt(2, 4);

            // Calculate Volumes
            const vol1 = (initLarge * largeVol) + (initSmall * smallVol);
            const addedVol = (addLarge * largeVol) + (addSmall * smallVol);
            const vol2 = vol1 + addedVol;

            // Target Question (What to ask for?)
            // If we added Large balls, we easily find Large Vol first. 
            // So asking for Small Vol makes it a 2-step problem (harder, like image).
            // Asking for Large Vol makes it 1-step (easier).
            // Let's randomize the target.
            const targetType = Math.random() > 0.5 ? 'large' : 'small';

            currentState = {
                largeVol, smallVol,
                initLarge, initSmall,
                addLarge, addSmall,
                vol1, vol2,
                targetType
            };

            // 3. Render Graphics
            renderStage('stage2-svg', initLarge, initSmall, vol1);
            renderStage('stage3-svg', initLarge + addLarge, initSmall + addSmall, vol2);

            // 4. Update Text
            document.getElementById('vol1-display').innerText = vol1;
            document.getElementById('vol2-display').innerText = vol2;

            updateQuestionText();
        }

        function updateQuestionText() {
            const { initLarge, initSmall, addLarge, addSmall, targetType, vol1, vol2 } = currentState;
            
            let step1Text = `雅誼先把 <b>${initLarge}</b> 粒大鐵珠和 <b>${initSmall}</b> 粒小鐵珠放進排水桶，排出的水量為 ${vol1} mL。`;
            let step2Text = `然後再把 <b>${addLarge > 0 ? addLarge : addSmall}</b> 粒${addLarge > 0 ? '大' : '小'}鐵珠放進排水桶，總排水量變為 ${vol2} mL。`;
            let question = `請問 1 粒<b>${targetType === 'large' ? '大' : '小'}鐵珠</b>的體積是多少立方厘米？`;

            document.getElementById('question-text').innerHTML = `${step1Text}<br>${step2Text}<br>${question}`;
        }

        function renderStage(svgId, nLarge, nSmall, vol) {
            const svg = document.getElementById(svgId);
            
            // Base Can + Measuring Cup Template
            // Note: SVG content is cleared and rebuilt
            let html = `
                <!-- Bucket -->
                <path d="M40 40 L40 180 Q40 200 60 200 L140 200 Q160 200 160 180 L160 80 L180 100" fill="none" stroke="#334155" stroke-width="3" stroke-linecap="round"/>
                <line x1="160" y1="80" x2="160" y2="40" stroke="#334155" stroke-width="3"/>
                <!-- Water in bucket (Always Full in these stages) -->
                <path d="M43 80 L43 180 Q43 197 60 197 L140 197 Q157 197 157 180 L157 80 Z" fill="#bae6fd" opacity="0.6"/>
                <line x1="43" y1="80" x2="157" y2="80" stroke="#0ea5e9" stroke-width="2"/>
            `;

            // Draw Balls (Simple packing logic)
            // We'll arrange them in rows at the bottom
            let ballsHtml = '';
            const startX = 60;
            const startY = 185;
            let currentX = startX;
            let currentY = startY;
            
            // Draw Large Balls
            for(let i=0; i<nLarge; i++) {
                ballsHtml += `<circle cx="${currentX}" cy="${currentY}" r="${DRAW_CONFIG.largeRadius}" fill="#94a3b8" stroke="#475569" stroke-width="2" class="ball">
                    <title>大鐵珠</title>
                </circle>`;
                // Simple highlight
                ballsHtml += `<path d="M${currentX-4} ${currentY-4} Q${currentX} ${currentY-8} ${currentX+4} ${currentY-4}" fill="none" stroke="white" opacity="0.5"/>`;
                
                currentX += 30;
                if(currentX > 140) { currentX = startX + 15; currentY -= 28; }
            }

            // Draw Small Balls
            for(let i=0; i<nSmall; i++) {
                // Ensure small balls don't overlap strangely if row changed
                if (currentX > 140) { currentX = startX + 10; currentY -= 25; }
                
                ballsHtml += `<circle cx="${currentX}" cy="${currentY+5}" r="${DRAW_CONFIG.smallRadius}" fill="#cbd5e1" stroke="#64748b" stroke-width="2" class="ball">
                    <title>小鐵珠</title>
                </circle>`;
                currentX += 22;
            }

            html += ballsHtml;

            // Draw Measuring Cup with Water Level
            // Max height in drawing is approx 160 units for the cup water area
            // Let's assume max displayable vol is ~300ml for scaling purposes
            const maxH = 160; 
            const waterHeight = Math.min((vol / DRAW_CONFIG.maxVolDisplay) * maxH, maxH);
            const waterY = 200 - waterHeight; // 200 is bottom y of cup path

            const cupHtml = `
                <g transform="translate(180, 100) scale(0.6)">
                    <!-- Water Level -->
                    <path d="M12 ${waterY} L12 180 Q12 198 30 198 L90 198 Q108 198 108 180 L108 ${waterY} Z" fill="#38bdf8" opacity="0.8" class="water"/>
                    
                    <!-- Cup Outline -->
                    <path d="M10 0 L10 180 Q10 200 30 200 L90 200 Q110 200 110 180 L110 0" fill="none" stroke="#334155" stroke-width="4"/>
                    
                    <!-- Graduation marks -->
                    <line x1="10" y1="160" x2="30" y2="160" stroke="#334155" stroke-width="2"/>
                    <line x1="10" y1="120" x2="30" y2="120" stroke="#334155" stroke-width="2"/>
                    <line x1="10" y1="80" x2="30" y2="80" stroke="#334155" stroke-width="2"/>
                    <line x1="10" y1="40" x2="30" y2="40" stroke="#334155" stroke-width="2"/>
                </g>
            `;

            html += cupHtml;
            svg.innerHTML = html;
        }

        function checkAnswer() {
            const userVal = parseInt(document.getElementById('user-answer').value);
            const inputEl = document.getElementById('user-answer');
            const feedbackPanel = document.getElementById('feedback-panel');
            const feedbackTitle = document.getElementById('feedback-title');
            const solutionContent = document.getElementById('solution-content');
            
            if (isNaN(userVal)) return;

            const correctVal = currentState.targetType === 'large' ? currentState.largeVol : currentState.smallVol;

            feedbackPanel.classList.remove('hidden', 'bg-red-50', 'border-red-200', 'bg-green-50', 'border-green-200');
            
            if (userVal === correctVal) {
                // Correct
                feedbackPanel.classList.add('bg-green-50', 'border-green-200');
                feedbackTitle.innerHTML = '<i class="fas fa-check-circle text-green-600"></i> 答對了！';
                feedbackTitle.className = "text-2xl font-bold mb-4 text-green-800";
                inputEl.classList.add('border-green-500', 'bg-green-50');
            } else {
                // Incorrect
                feedbackPanel.classList.add('bg-red-50', 'border-red-200');
                feedbackTitle.innerHTML = '<i class="fas fa-times-circle text-red-600"></i> 答案不正確，請看解析：';
                feedbackTitle.className = "text-2xl font-bold mb-4 text-red-800";
                inputEl.classList.add('border-red-500', 'bg-red-50');
            }

            // Generate Explanation
            const { initLarge, initSmall, addLarge, addSmall, vol1, vol2, largeVol, smallVol, targetType } = currentState;
            
            // Logic explanation vars
            const diffVol = vol2 - vol1;
            const addedCount = addLarge > 0 ? addLarge : addSmall;
            const addedName = addLarge > 0 ? "大鐵珠" : "小鐵珠";
            const addedSingleVol = diffVol / addedCount;
            
            let html = `<p class="font-bold">步驟 1：找出後加入的鐵珠體積</p>`;
            html += `<ul class="list-disc list-inside ml-4 mb-4">`;
            html += `<li>第一次排水量：${vol1} mL</li>`;
            html += `<li>第二次總排水量：${vol2} mL</li>`;
            html += `<li>增加的水量 = ${vol2} - ${vol1} = <span class="text-blue-600 font-bold">${diffVol} mL</span></li>`;
            html += `<li>增加的物體是：${addedCount} 粒${addedName}</li>`;
            html += `<li>所以，1 粒${addedName}的體積 = ${diffVol} ÷ ${addedCount} = <span class="text-blue-600 font-bold">${addedSingleVol} cm³</span></li>`;
            html += `</ul>`;

            // If the question asked for the one we just found
            if ((targetType === 'large' && addLarge > 0) || (targetType === 'small' && addSmall > 0)) {
                html += `<p class="font-bold text-green-700">題目問的是${addedName}的體積，答案就是 ${addedSingleVol} cm³。</p>`;
            } else {
                // Need step 2
                html += `<p class="font-bold">步驟 2：利用第一階段的數據找出另一種鐵珠的體積</p>`;
                html += `<ul class="list-disc list-inside ml-4 mb-4">`;
                html += `<li>我們已知 1 粒${addedName}體積是 ${addedSingleVol} cm³。</li>`;
                html += `<li>第一階段放入了：${initLarge} 粒大鐵珠 和 ${initSmall} 粒小鐵珠。總體積是 ${vol1} mL。</li>`;
                
                let equationStr = "";
                let calcStr = "";
                let finalAns = 0;

                if (targetType === 'small') {
                    // We found Large, need Small
                    // Equation: (initLarge * Large) + (initSmall * Small) = vol1
                    const knownPart = initLarge * largeVol;
                    const remaining = vol1 - knownPart;
                    finalAns = remaining / initSmall;
                    
                    html += `<li>${initLarge} 粒大鐵珠的體積 = ${initLarge} × ${largeVol} = ${knownPart} mL</li>`;
                    html += `<li>剩下的體積是小鐵珠的：${vol1} - ${knownPart} = ${remaining} mL</li>`;
                    html += `<li>因為有 ${initSmall} 粒小鐵珠，所以 1 粒小鐵珠 = ${remaining} ÷ ${initSmall} = <span class="text-green-700 font-bold text-xl">${finalAns} cm³</span></li>`;
                } else {
                    // We found Small, need Large
                    const knownPart = initSmall * smallVol;
                    const remaining = vol1 - knownPart;
                    finalAns = remaining / initLarge;

                    html += `<li>${initSmall} 粒小鐵珠的體積 = ${initSmall} × ${smallVol} = ${knownPart} mL</li>`;
                    html += `<li>剩下的體積是大鐵珠的：${vol1} - ${knownPart} = ${remaining} mL</li>`;
                    html += `<li>因為有 ${initLarge} 粒大鐵珠，所以 1 粒大鐵珠 = ${remaining} ÷ ${initLarge} = <span class="text-green-700 font-bold text-xl">${finalAns} cm³</span></li>`;
                }
                html += `</ul>`;
            }

            solutionContent.innerHTML = html;
        }

        // Init
        generateQuestion();

    </script>
</body>
</html>